<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRUTALTOOLS - Online PDF Tools for Free</title>
    <meta name="description" content="Edit, convert, merge, compress PDFs easily with BRUTALTOOLS.">
    
    <!-- Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --primary: #6A0DAD;
            --primary-dark: #4b0082;
            --primary-light: #9d4edd;
            --secondary: #f3e5f5;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --white: #ffffff;
            --bg-light: #f9fafb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 rgba(16, 185, 129, 0); } }

        /* Header */
        header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.25rem; font-weight: 800; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; letter-spacing: -0.5px; }
        .nav-links { display: flex; gap: 2rem; list-style: none; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--text-dark); font-weight: 500; font-size: 0.95rem; transition: var(--transition); }
        .nav-links a:hover { color: var(--primary); }
        .btn-cta { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--white); padding: 0.6rem 1.5rem; border-radius: 50px; font-weight: 600; text-decoration: none; box-shadow: 0 4px 15px rgba(106, 13, 173, 0.3); transition: var(--transition); font-size: 0.9rem;}
        .btn-cta:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(106, 13, 173, 0.4); }
        .menu-toggle { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text-dark); padding: 5px; }

        /* Hero */
        .hero { text-align: center; padding: 3rem 1rem 2rem; background: radial-gradient(circle at center, var(--secondary) 0%, rgba(255,255,255,0) 70%); }
        .hero h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 1rem; color: var(--text-dark); line-height: 1.2;}
        .hero h1 span { color: var(--primary); }
        .hero p { color: var(--text-gray); font-size: 1rem; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* Tools Controls */
        .tools-controls { max-width: 1000px; margin: 0 auto 2rem; padding: 0 1rem; display: flex; flex-direction: column; gap: 1rem; align-items: center; }
        .search-box { position: relative; width: 100%; max-width: 500px; }
        .search-box input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 2px solid transparent; background-color: var(--white); border-radius: 50px; font-size: 1rem; box-shadow: var(--shadow-md); transition: var(--transition); font-family: inherit; }
        .search-box input:focus { outline: none; border-color: var(--primary-light); box-shadow: var(--shadow-lg); }
        .search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-gray); font-size: 0.9rem; }
        .categories { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
        .category-btn { background: transparent; border: 1px solid #e5e7eb; padding: 0.4rem 1rem; border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 0.85rem; color: var(--text-gray); transition: var(--transition); white-space: nowrap;}
        .category-btn:hover, .category-btn.active { background-color: var(--primary); color: var(--white); border-color: var(--primary); }

        /* Tools Grid */
        .tools-section { max-width: 1200px; margin: 0 auto 4rem; padding: 0 1rem; }
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
        .tool-card { background: var(--white); border-radius: var(--radius); padding: 1.5rem; text-align: left; box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition); display: flex; flex-direction: column; align-items: flex-start; border: 1px solid transparent; animation: fadeIn 0.5s ease forwards; }
        .tool-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--primary-light); }
        .tool-icon { width: 40px; height: 40px; background-color: var(--secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); margin-bottom: 1rem; transition: var(--transition); }
        .tool-card:hover .tool-icon { background-color: var(--primary); color: var(--white); }
        .tool-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-dark); }
        .tool-desc { font-size: 0.85rem; color: var(--text-gray); }

        /* Workspace */
        #workspace { display: none; min-height: 80vh; padding: 1rem; background-color: var(--white); }
        .workspace-container { max-width: 1000px; margin: 0 auto; text-align: center; }
        .back-nav { margin-bottom: 1.5rem; display: flex; justify-content: flex-start; }
        .back-btn { background: none; border: none; color: var(--text-gray); font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: var(--transition); padding: 0.5rem; }
        .back-btn:hover { color: var(--primary); }

        /* Steps */
        .step-wrapper { position: relative; padding-left: 50px; text-align: left; margin-bottom: 2rem; display: none; animation: fadeIn 0.5s ease forwards; }
        .step-wrapper.active { display: block; }
        .step-wrapper:first-child { display: block; }
        .step-wrapper:not(:last-child)::before { content: ''; position: absolute; left: 19px; top: 35px; bottom: -20px; width: 2px; background-color: #e5e7eb; z-index: 0; }
        .step-number { position: absolute; left: 0; top: 0; width: 40px; height: 40px; background-color: var(--secondary); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; z-index: 1; border: 3px solid var(--white); box-shadow: 0 0 0 1px #e5e7eb; transition: var(--transition); }
        .step-wrapper.active .step-number { background-color: var(--primary); color: var(--white); box-shadow: 0 0 0 4px var(--secondary); }
        .step-content { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background-color: #fff; box-shadow: var(--shadow-sm); transition: var(--transition); position: relative; }
        .step-content:hover { box-shadow: var(--shadow-md); border-color: var(--primary-light); }
        .step-title { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; display: flex; flex-direction: column; gap: 5px; align-items: flex-start;}

        /* Tool Options (Inputs) */
        .tool-options { margin-bottom: 1.5rem; padding: 1rem 1.5rem; background-color: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; align-items: stretch; }
        .tool-input-group { flex: 1; min-width: 100%; margin-bottom: 0; }
        .tool-input-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark); font-size: 0.9rem; }
        .tool-input { width: 100%; padding: 0.8rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; font-family: inherit; background-color: #fff; transition: var(--transition); }
        .tool-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--secondary); }

        /* Upload Area */
        .upload-area { border: 3px dashed #e5e7eb; border-radius: 12px; padding: 2rem 1rem; background-color: #fafafa; transition: var(--transition); cursor: pointer; position: relative; }
        .upload-area.drag-over { border-color: var(--primary); background-color: var(--secondary); }
        .upload-icon-lg { font-size: 2.5rem; color: #d1d5db; margin-bottom: 1rem; transition: var(--transition); }
        .upload-area:hover .upload-icon-lg { color: var(--primary); transform: scale(1.1); }

        /* PREVIEW STAGE & CONTROLS */
        .preview-controls {
            display: flex;
            flex-direction: row; /* Desktop Default */
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            gap: 1rem;
        }
        .zoom-control {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            justify-content: flex-end;
        }
        .zoom-slider {
            width: 100px;
            cursor: pointer;
            touch-action: manipulation; /* Improves touch scroll */
        }

        .preview-stage-container {
            background-color: #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            min-height: 300px;
            max-height: 70vh;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            border: 1px solid #d1d5db;
            transition: background-color 0.2s;
        }
        
        .preview-stage-container.drag-over-stage {
            background-color: #e0e7ff;
            border-style: dashed;
            border-color: var(--primary);
        }

        .preview-page-wrapper {
            position: relative;
            background: white;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            user-select: none;
            touch-action: none;
        }

        /* Dragging State */
        .preview-page-wrapper.dragging {
            opacity: 0.4;
            border: 2px dashed var(--primary);
        }
        .preview-page-wrapper:hover {
            transform: translateY(-5px);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .preview-canvas {
            display: block;
            max-width: 100%;
            height: auto;
            pointer-events: none;
        }

        /* Toolbar Overlay */
        .page-toolbar {
            position: absolute;
            top: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.8);
            padding: 5px;
            display: flex;
            justify-content: space-between;
            gap: 5px;
            border-radius: 8px 8px 0 0;
            opacity: 1;
            transition: opacity 0.2s;
        }
        
        .toolbar-group {
            display: flex;
            gap: 4px;
        }

        .toolbar-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
            width: 40px; /* Larger touch target */
            height: 40px;
            font-size: 1rem;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toolbar-btn:hover { background: rgba(255,255,255,0.4); }
        .toolbar-btn.delete:hover { background: #ef4444; }
        
        /* Mobile Specific Buttons (Up/Down) */
        .mobile-only-btn {
            display: none; /* Hidden on Desktop */
        }

        /* Badges */
        .page-badge {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-gray);
            font-weight: 600;
        }

        /* Process Button */
        .process-area { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 1rem; }
        .process-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--white); border: none; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 600; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(106, 13, 173, 0.3); transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem; width: 100%; max-width: 400px; justify-content: center; }
        .process-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(106, 13, 173, 0.4); }
        .process-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .process-btn.success-mode {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 0 5px rgba(16, 185, 129, 0.5);
            animation: pulse-green 2s infinite;
        }

        .progress-container { width: 100%; max-width: 400px; display: none; margin-top: 0.5rem; }
        .progress-bar { width: 100%; height: 10px; background-color: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); transition: width 0.2s ease; border-radius: 5px; }
        
        .status-message { font-size: 1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; min-height: 1.2rem; display: flex; align-items: center; gap: 0.5rem; justify-content: center; text-align: center; }
        .status-text-success { color: var(--primary); }
        .status-error { color: #ef4444; }

        /* Footer */
        footer { background-color: #111827; color: #9ca3af; padding: 3rem 1.5rem 2rem; margin-top: auto; }
        .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 3rem; }
        .footer-brand h2 { color: var(--white); margin-bottom: 1rem; }
        .footer-links h3 { color: var(--white); margin-bottom: 1rem; font-size: 1.1rem; }
        .footer-links ul { list-style: none; }
        .footer-links ul li { margin-bottom: 0.5rem; }
        .footer-links a { color: #9ca3af; text-decoration: none; transition: var(--transition); }
        .footer-links a:hover { color: var(--primary); }
        .footer-bottom { text-align: center; border-top: 1px solid #374151; padding-top: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .social-icons a { color: var(--white); margin-left: 1rem; font-size: 1.2rem; transition: var(--transition); }
        .social-icons a:hover { color: var(--primary); }

        /* Toast */
        .toast { position: fixed; bottom: 2rem; right: 2rem; background-color: #333; color: #fff; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 1000; transform: translateY(100px); opacity: 0; transition: var(--transition); display: flex; align-items: center; gap: 0.8rem; max-width: 90%; left: 1rem; right: 1rem; margin: 0 auto;}
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 5px solid #10b981; }
        .toast.error { border-left: 5px solid #ef4444; }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .menu-toggle { display: block; }
            
            .tools-grid { grid-template-columns: 1fr; }
            .step-wrapper { padding-left: 40px; }
            
            .preview-controls { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch;
                text-align: center;
            }
            .zoom-control { 
                justify-content: center; 
                width: 100%;
                background: rgba(255,255,255,0.5);
                padding: 5px;
                border-radius: 8px;
            }
            .zoom-slider { width: 100%; }
            
            .preview-stage-container { 
                justify-content: center; 
                padding: 0.5rem;
            }
            
            .preview-page-wrapper {
                width: 90%; 
            }

            .mobile-only-btn {
                display: flex;
            }
            
            .desktop-hint {
                display: none;
            }
            
            .toolbar-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="nav-container">
            <a href="#" class="logo" onclick="resetApp()">
                <i class="fa-solid fa-layer-group"></i> BRUTALTOOLS
            </a>
            <nav>
                <ul class="nav-links">
                    <li><a href="#" onclick="resetApp()">Home</a></li>
                    <li><a href="#">Pricing</a></li>
                    <li><a href="#">Security</a></li>
                </ul>
            </nav>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="#" class="btn-cta">Get Started</a>
                <div class="menu-toggle"><i class="fa-solid fa-bars"></i></div>
            </div>
        </div>
    </header>

    <main id="main-content">
        <section class="hero">
            <h1>Every PDF Tool You Need <br><span>100% Free</span></h1>
            <p>Edit, convert, merge, compress PDFs easily with BRUTALTOOLS. Secure, fast, and completely online with live previews.</p>
        </section>

        <section class="tools-controls">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="toolSearch" placeholder="Search for a tool..." onkeyup="filterTools()">
            </div>
            <div class="categories">
                <button class="category-btn active" onclick="filterCategory('all', this)">All</button>
                <button class="category-btn" onclick="filterCategory('organize', this)">Organize</button>
                <button class="category-btn" onclick="filterCategory('convert', this)">Convert to PDF</button>
                <button class="category-btn" onclick="filterCategory('convert-from', this)">Convert from PDF</button>
                <button class="category-btn" onclick="filterCategory('optimize', this)">Optimize</button>
                <button class="category-btn" onclick="filterCategory('security', this)">Security</button>
            </div>
        </section>

        <section class="tools-section">
            <div class="tools-grid" id="toolsGrid">
                
                <!-- Organize -->
                <div class="tool-card" data-category="organize" onclick="openTool('Merge PDF', 'merge')">
                    <div class="tool-icon"><i class="fa-solid fa-layer-group"></i></div>
                    <div class="tool-title">Merge PDF</div>
                    <div class="tool-desc">Combine multiple PDFs into one.</div>
                </div>
                <div class="tool-card" data-category="organize" onclick="openTool('Split PDF', 'split')">
                    <div class="tool-icon"><i class="fa-solid fa-scissors"></i></div>
                    <div class="tool-title">Split PDF</div>
                    <div class="tool-desc">Separate PDF into individual files.</div>
                </div>
                <div class="tool-card" data-category="organize" onclick="openTool('Rotate PDF', 'rotate')">
                    <div class="tool-icon"><i class="fa-solid fa-rotate-right"></i></div>
                    <div class="tool-title">Rotate PDF</div>
                    <div class="tool-desc">Rotate pages 90 degrees.</div>
                </div>
                <div class="tool-card" data-category="organize" onclick="openTool('Add Page Numbers', 'pagenumbers')">
                    <div class="tool-icon"><i class="fa-solid fa-list-ol"></i></div>
                    <div class="tool-title">Add Page Numbers</div>
                    <div class="tool-desc">Number pages automatically.</div>
                </div>

                <!-- Convert to PDF -->
                <div class="tool-card" data-category="convert" onclick="openTool('JPG to PDF', 'img2pdf')">
                    <div class="tool-icon"><i class="fa-solid fa-image"></i></div>
                    <div class="tool-title">JPG to PDF</div>
                    <div class="tool-desc">Convert images to PDF.</div>
                </div>
                <div class="tool-card" data-category="convert" onclick="openTool('Word to PDF', 'office2pdf')">
                    <div class="tool-icon"><i class="fa-solid fa-file-word"></i></div>
                    <div class="tool-title">Word to PDF</div>
                    <div class="tool-desc">Convert DOC/DOCX files.</div>
                </div>
                <div class="tool-card" data-category="convert" onclick="openTool('PowerPoint to PDF', 'office2pdf')">
                    <div class="tool-icon"><i class="fa-solid fa-file-powerpoint"></i></div>
                    <div class="tool-title">PowerPoint to PDF</div>
                    <div class="tool-desc">Convert PPT/PPTX files.</div>
                </div>
                <div class="tool-card" data-category="convert" onclick="openTool('Excel to PDF', 'office2pdf')">
                    <div class="tool-icon"><i class="fa-solid fa-file-excel"></i></div>
                    <div class="tool-title">Excel to PDF</div>
                    <div class="tool-desc">Convert XLS/XLSX files.</div>
                </div>

                <!-- Convert from PDF -->
                <div class="tool-card" data-category="convert-from" onclick="openTool('PDF to JPG', 'pdf2img')">
                    <div class="tool-icon"><i class="fa-solid fa-images"></i></div>
                    <div class="tool-title">PDF to JPG</div>
                    <div class="tool-desc">Extract pages as images.</div>
                </div>

                <!-- Optimize -->
                <div class="tool-card" data-category="optimize" onclick="openTool('Compress PDF', 'compress')">
                    <div class="tool-icon"><i class="fa-solid fa-compress"></i></div>
                    <div class="tool-title">Compress PDF</div>
                    <div class="tool-desc">Reduce file size.</div>
                </div>

                <!-- Security & Edit -->
                <div class="tool-card" data-category="security" onclick="openTool('Watermark PDF', 'watermark')">
                    <div class="tool-icon"><i class="fa-solid fa-copyright"></i></div>
                    <div class="tool-title">Watermark PDF</div>
                    <div class="tool-desc">Add text watermark live.</div>
                </div>
                <div class="tool-card" data-category="security" onclick="openTool('Protect PDF', 'protect')">
                    <div class="tool-icon"><i class="fa-solid fa-shield-halved"></i></div>
                    <div class="tool-title">Protect PDF</div>
                    <div class="tool-desc">Add password protection.</div>
                </div>
                <div class="tool-card" data-category="security" onclick="openTool('Unlock PDF', 'unlock')">
                    <div class="tool-icon"><i class="fa-solid fa-unlock"></i></div>
                    <div class="tool-title">Unlock PDF</div>
                    <div class="tool-desc">Remove password.</div>
                </div>

            </div>
        </section>
    </main>

    <!-- Workspace -->
    <div id="workspace">
        <div class="workspace-container">
            <div class="back-nav">
                <button class="back-btn" onclick="resetApp()">
                    <i class="fa-solid fa-arrow-left"></i> Back to Tools
                </button>
            </div>
            <h2 id="workspaceTitle" style="margin-bottom: 0.5rem; font-weight: 700; color: var(--text-dark);">Tool Name</h2>
            <p id="workspaceDesc" style="margin-bottom: 2rem; color: var(--text-gray);">Tool description goes here.</p>

            <!-- STEP 1 -->
            <div class="step-wrapper active" id="step1">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Select Files</div>
                    <div class="upload-area" id="dropZone">
                        <i class="fa-solid fa-cloud-arrow-up upload-icon-lg"></i>
                        <h3>Click to upload or drag & drop</h3>
                        <p style="color: #9ca3af; margin-top: 0.5rem; font-size: 0.9rem;">Supported: PDF, JPG, PNG, DOC, XLS</p>
                        <input type="file" id="fileInput" multiple style="display: none;">
                    </div>
                </div>
            </div>

            <!-- STEP 2 (REVISED) -->
            <div class="step-wrapper" id="step2">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">
                        <span>Edit & Preview</span>
                        <span style="font-size:0.8rem; font-weight:400; color: #64748b; margin-top:5px;" class="desktop-hint">Drag pages to reorder • Use arrows on mobile</span>
                    </div>
                    
                    <!-- Dynamic Controls -->
                    <div id="toolOptionsArea" class="tool-options" style="display:none;">
                        <!-- Inputs injected here -->
                    </div>

                    <!-- Preview Controls (Zoom) -->
                    <div class="preview-controls">
                        <span style="font-size:0.9rem; font-weight:600; color:var(--text-dark);">Pages: <span id="pageCountDisplay">0</span></span>
                        <div class="zoom-control">
                            <i class="fa-solid fa-magnifying-glass-minus" style="color:#666;"></i>
                            <input type="range" min="0.3" max="1.5" step="0.1" value="0.6" class="zoom-slider" id="zoomSlider" oninput="updateZoom(this.value)">
                            <i class="fa-solid fa-magnifying-glass-plus" style="color:#666;"></i>
                        </div>
                    </div>

                    <!-- Live Preview Stage -->
                    <div class="preview-stage-container" id="previewStage">
                        <!-- Canvases injected here -->
                    </div>
                </div>
            </div>

            <!-- STEP 3 -->
            <div class="step-wrapper" id="step3">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Finalize & Download</div>
                    <div class="process-area">
                        <div class="status-message" id="statusMessage"></div>
                        
                        <button class="process-btn" id="processBtn" onclick="processFiles()">
                            <span id="btnText">Process File</span> <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        
                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-brand">
                <h2>BRUTALTOOLS</h2>
                <p>The ultimate online PDF solution. Secure, fast, and free forever.</p>
            </div>
            <div class="footer-links">
                <h3>BRUTALTOOLS</h3>
                <ul>
                    <li><a href="#">Home</a></li>
                    <li><a href="#">Pricing</a></li>
                    <li><a href="#">Security</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h3>Product</h3>
                <ul>
                    <li><a href="#">PDF to Word</a></li>
                    <li><a href="#">Merge PDF</a></li>
                    <li><a href="#">Compress PDF</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>BRUTALTOOLS © 2026</p>
            <div class="social-icons">
                <a href="#"><i class="fa-brands fa-twitter"></i></a>
                <a href="#"><i class="fa-brands fa-facebook"></i></a>
                <a href="#"><i class="fa-brands fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <div id="toast" class="toast">
        <i class="fa-solid fa-circle-check"></i>
        <span id="toastMessage">Operation successful</span>
    </div>

    <script>
        // --- Global State ---
        let currentTool = null;
        let currentMode = null;
        let selectedFiles = [];
        let processedPages = []; // Stores {id, file, pageIndex, rotation}
        let isProcessing = false;
        let globalResultBlob = null;
        let watermarkText = "BRUTALTOOLS";
        let currentZoom = 0.6;

        // Drag & Drop State
        let draggedItemIndex = null;

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const workspace = document.getElementById('workspace');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewStage = document.getElementById('previewStage');
        const processBtn = document.getElementById('processBtn');
        const btnText = document.getElementById('btnText');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const toolOptionsArea = document.getElementById('toolOptionsArea');
        const pageCountDisplay = document.getElementById('pageCountDisplay');

        // --- Tool Configuration ---
        function openTool(title, mode) {
            currentTool = title;
            currentMode = mode;
            document.getElementById('workspaceTitle').innerText = title;
            
            // Reset Data
            selectedFiles = [];
            processedPages = [];
            watermarkText = "BRUTALTOOLS";
            currentZoom = 0.6;
            document.getElementById('zoomSlider').value = currentZoom;
            
            // Handle Dynamic Inputs
            toolOptionsArea.innerHTML = ''; 
            
            if(mode === 'watermark') {
                const input = createInput('Watermark Text', 'text', 'BRUTALTOOLS');
                input.addEventListener('input', (e) => {
                    watermarkText = e.target.value;
                    updateWatermarkOverlay();
                });
                toolOptionsArea.appendChild(input);
                toolOptionsArea.style.display = 'flex';
            } else if(mode === 'protect') {
                toolOptionsArea.appendChild(createInput('Set Password', 'password', ''));
                toolOptionsArea.style.display = 'flex';
            } else if(mode === 'unlock') {
                toolOptionsArea.appendChild(createInput('Enter Password to Unlock', 'password', ''));
                toolOptionsArea.style.display = 'flex';
            } else {
                toolOptionsArea.style.display = 'none';
            }

            // Reset UI
            resetUIState();
            
            // Show Workspace
            mainContent.style.display = 'none';
            workspace.style.display = 'block';
            window.scrollTo(0, 0);
        }

        function createInput(label, type, placeholder) {
            const div = document.createElement('div');
            div.className = 'tool-input-group';
            div.innerHTML = `
                <label class="tool-input-label">${label}</label>
                <input type="${type}" class="tool-input" placeholder="${placeholder}" value="${placeholder}">
            `;
            return div;
        }

        function resetApp() { 
            workspace.style.display = 'none'; 
            mainContent.style.display = 'block'; 
        }

        function resetUIState() {
            step2.classList.remove('active');
            step3.classList.remove('active');
            previewStage.innerHTML = ''; 
            previewStage.className = 'preview-stage-container';
            pageCountDisplay.innerText = '0';
            
            processBtn.className = "process-btn";
            processBtn.disabled = false;
            processBtn.onclick = processFiles;
            btnText.innerText = getButtonText();
            progressContainer.style.display = 'none';
            statusMessage.innerHTML = '';
        }

        function getButtonText() {
            if(currentMode === 'merge') return 'Merge PDF';
            else if(currentMode === 'split') return 'Split PDF';
            else if(currentMode === 'rotate') return 'Rotate PDF';
            else if(currentMode === 'img2pdf') return 'Convert to PDF';
            else if(currentMode === 'office2pdf') return 'Convert to PDF';
            else if(currentMode === 'pdf2img') return 'Convert to JPG';
            else if(currentMode === 'pagenumbers') return 'Add Numbers';
            else if(currentMode === 'watermark') return 'Add Watermark';
            else if(currentMode === 'compress') return 'Compress PDF';
            else if(currentMode === 'protect') return 'Protect PDF';
            else if(currentMode === 'unlock') return 'Unlock PDF';
            else return 'Process File';
        }

        // --- Drag & Drop File Upload ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            if(['pdf2img', 'split', 'rotate', 'pagenumbers', 'watermark', 'compress', 'protect', 'unlock', 'office2pdf'].includes(currentMode)) {
                if(files.length > 1) { showToast('Please select only one file for this tool.', 'error'); return; }
            }
            
            if (currentMode === 'img2pdf') {
                 if(!Array.from(files).every(f => f.type.match('image.*'))) { showToast('Only images allowed.', 'error'); return; }
            }

            Array.from(files).forEach(file => {
                if (currentMode !== 'img2pdf' && file.type !== 'application/pdf' && currentMode !== 'office2pdf') {
                     showToast(`Skipped ${file.name}: Not a PDF.`, 'error');
                     return;
                }
                selectedFiles.push(file);
            });

            if(selectedFiles.length > 0) {
                step2.classList.add('active');
                step3.classList.add('active');
                generateLivePreview();
            }
        }

        // --- ZOOM ---
        function updateZoom(val) {
            currentZoom = parseFloat(val);
            const wrappers = document.querySelectorAll('.preview-page-wrapper');
            wrappers.forEach(w => {
               w.style.transform = `scale(${currentZoom})`;
               w.style.margin = `${20 * (1-currentZoom)}px ${50 * (1-currentZoom)}px`;
            });
        }

        // --- PREVIEW GENERATION ENGINE ---
        async function generateLivePreview() {
            previewStage.innerHTML = '<div style="color: #6b7280; padding: 2rem;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading preview...</div>';
            
            try {
                if (currentMode === 'img2pdf') {
                    await renderImagePreviews();
                } else if (currentMode === 'office2pdf') {
                    previewStage.innerHTML = `
                        <div style="text-align:center; padding: 2rem; color: var(--text-dark);">
                            <i class="fa-solid fa-file-word" style="font-size: 4rem; color: #2b579a; margin-bottom:1rem;"></i>
                            <h3>${selectedFiles[0].name}</h3>
                            <p>Ready for conversion.</p>
                        </div>`;
                    pageCountDisplay.innerText = "1";
                } else {
                    await renderPDFPreviews();
                }
                updateZoom(document.getElementById('zoomSlider').value);
            } catch (err) {
                console.error(err);
                previewStage.innerHTML = '<div style="color:red; padding:1rem;">Error loading PDF. Please ensure it is not corrupted or heavily encrypted.</div>';
            }
        }

        async function renderImagePreviews() {
            previewStage.innerHTML = '';
            processedPages = [];
            selectedFiles.forEach((file, idx) => {
                const id = `img-${idx}`;
                processedPages.push({ id: id, file: file, pageIndex: 0, rotation: 0, type: 'image' });
                
                const url = URL.createObjectURL(file);
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-page-wrapper';
                wrapper.setAttribute('draggable', 'true');
                wrapper.dataset.id = id;
                
                const toolbar = `
                    <div class="page-toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn mobile-only-btn" onclick="movePage('${id}', -1)" title="Move Up"><i class="fa-solid fa-chevron-up"></i></button>
                            <button class="toolbar-btn mobile-only-btn" onclick="movePage('${id}', 1)" title="Move Down"><i class="fa-solid fa-chevron-down"></i></button>
                        </div>
                        <div class="toolbar-group">
                            <button class="toolbar-btn" onclick="rotatePage('${id}', -90)" title="Rotate Left"><i class="fa-solid fa-rotate-left"></i></button>
                            <button class="toolbar-btn" onclick="rotatePage('${id}', 90)" title="Rotate Right"><i class="fa-solid fa-rotate-right"></i></button>
                            <button class="toolbar-btn delete" onclick="removePage('${id}')" title="Remove"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;

                // Build inner HTML without canvas
                wrapper.innerHTML = `
                    ${toolbar}
                    <div class="canvas-wrapper"></div>
                    <div class="page-badge">Image ${idx + 1}</div>
                `;
                
                const img = document.createElement('img');
                img.src = url;
                img.className = 'preview-canvas';
                wrapper.querySelector('.canvas-wrapper').appendChild(img);
                
                addDragEvents(wrapper);
                previewStage.appendChild(wrapper);
            });
            pageCountDisplay.innerText = processedPages.length;
        }

        async function renderPDFPreviews() {
            previewStage.innerHTML = '';
            processedPages = [];
            
            const filesToProcess = (currentMode === 'merge') ? selectedFiles : [selectedFiles[0]];

            for (let fIndex = 0; fIndex < filesToProcess.length; fIndex++) {
                const file = filesToProcess[fIndex];
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                const pageCount = pdfDoc.numPages;

                let renderLimit = pageCount;
                if (currentMode !== 'merge' && pageCount > 20) renderLimit = 20;

                for (let i = 1; i <= renderLimit; i++) {
                    const page = await pdfDoc.getPage(i);
                    // Scale 0.6 for good speed/quality balance
                    const viewport = page.getViewport({ scale: 0.6 }); 
                    
                    const id = `${fIndex}-${i}`;
                    processedPages.push({ id: id, fileIndex: fIndex, pageIndex: i, file: file, rotation: 0 });

                    const wrapper = document.createElement('div');
                    wrapper.className = 'preview-page-wrapper';
                    wrapper.id = `page-wrap-${id}`;
                    wrapper.dataset.id = id;
                    
                    if(currentMode === 'merge') wrapper.setAttribute('draggable', 'true');

                    // Create Canvas Element
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.className = 'preview-canvas';
                    
                    const renderContext = { canvasContext: canvas.getContext('2d'), viewport: viewport };
                    await page.render(renderContext).promise;
                    
                    let toolbarHTML = '';
                    let overlayHTML = '';

                    if (currentMode === 'merge') {
                        toolbarHTML = `
                            <div class="page-toolbar">
                                <div class="toolbar-group">
                                    <button class="toolbar-btn mobile-only-btn" onclick="movePage('${id}', -1)"><i class="fa-solid fa-chevron-up"></i></button>
                                    <button class="toolbar-btn mobile-only-btn" onclick="movePage('${id}', 1)"><i class="fa-solid fa-chevron-down"></i></button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="rotatePage('${id}', -90)" title="Rotate Left"><i class="fa-solid fa-rotate-left"></i></button>
                                    <button class="toolbar-btn" onclick="rotatePage('${id}', 90)" title="Rotate Right"><i class="fa-solid fa-rotate-right"></i></button>
                                    <button class="toolbar-btn delete" onclick="removePage('${id}')" title="Remove"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        `;
                        addDragEvents(wrapper);
                    } else if (currentMode === 'rotate') {
                        toolbarHTML = `
                            <div class="page-toolbar">
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="rotatePage('${id}', -90)"><i class="fa-solid fa-rotate-left"></i></button>
                                    <button class="toolbar-btn" onclick="rotatePage('${id}', 90)"><i class="fa-solid fa-rotate-right"></i></button>
                                </div>
                            </div>
                        `;
                    }

                    if (currentMode === 'watermark') {
                        overlayHTML = `<div class="preview-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; display:flex; align-items:center; justify-content:center;"><div class="watermark-text" style="font-size:2rem; font-weight:700; color:rgba(200,200,200,0.5); transform:rotate(-45deg); user-select:none;">${watermarkText}</div></div>`;
                    }
                    
                    if (currentMode === 'pagenumbers') {
                         overlayHTML = `<div class="preview-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"><div class="pagenumber-text" style="position:absolute; bottom:10px; right:10px; font-size:0.8rem;">${i}</div></div>`;
                    }

                    // SET HTML FIRST, THEN APPEND CANVAS
                    // This is critical: outerHTML strips canvas data, so we append the node directly.
                    wrapper.innerHTML = `
                        ${toolbarHTML}
                        <div class="canvas-wrapper"></div>
                        ${overlayHTML}
                        <div class="page-badge">Page ${i}</div>
                    `;
                    
                    // Append the rendered canvas to the wrapper
                    wrapper.querySelector('.canvas-wrapper').appendChild(canvas);
                    
                    previewStage.appendChild(wrapper);
                }
                
                if (renderLimit < pageCount && currentMode !== 'merge') {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.padding = '2rem';
                    moreDiv.style.color = '#666';
                    moreDiv.innerText = `... and ${pageCount - renderLimit} more pages (preview limited for performance)`;
                    previewStage.appendChild(moreDiv);
                }
            }
            pageCountDisplay.innerText = processedPages.length;
        }

        // --- MOBILE REORDER LOGIC ---
        function movePage(id, direction) {
            const index = processedPages.findIndex(p => p.id === id);
            const newIndex = index + direction;
            
            if (newIndex >= 0 && newIndex < processedPages.length) {
                const item = processedPages[index];
                processedPages[index] = processedPages[newIndex];
                processedPages[newIndex] = item;
                generateLivePreview();
                showToast('Page order updated', 'success');
            }
        }

        // --- DRAG AND DROP LOGIC (PC) ---
        function addDragEvents(el) {
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragenter', handleDragEnter);
            el.addEventListener('dragover', handleDragOver);
            el.addEventListener('dragleave', handleDragLeave);
            el.addEventListener('drop', handleDrop);
            el.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            draggedItemIndex = processedPages.findIndex(p => p.id === this.dataset.id);
            e.dataTransfer.effectAllowed = 'move';
            const img = new Image();
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            e.dataTransfer.setDragImage(img, 0, 0);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over-stage');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over-stage');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            const targetId = this.dataset.id;
            const targetIndex = processedPages.findIndex(p => p.id === targetId);

            if (draggedItemIndex !== null && draggedItemIndex !== targetIndex) {
                const item = processedPages.splice(draggedItemIndex, 1)[0];
                processedPages.splice(targetIndex, 0, item);
                generateLivePreview();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const items = document.querySelectorAll('.preview-page-wrapper');
            items.forEach(item => item.classList.remove('drag-over-stage'));
        }

        // --- Interactive Functions ---
        function updateWatermarkOverlay() {
            if(currentMode !== 'watermark') return;
            const texts = document.querySelectorAll('.watermark-text');
            texts.forEach(el => el.innerText = watermarkText);
        }

        function rotatePage(id, degrees) {
            const pageObj = processedPages.find(p => p.id === id);
            if(pageObj) {
                pageObj.rotation = (pageObj.rotation || 0) + degrees;
                const wrapper = document.getElementById(`page-wrap-${id}`) || document.querySelector(`[data-id="${id}"]`);
                const canvas = wrapper.querySelector('.preview-canvas') || wrapper.querySelector('img');
                canvas.style.transition = 'transform 0.3s ease';
                canvas.style.transform = `rotate(${pageObj.rotation}deg)`;
            }
        }

        function removePage(id) {
            const wrapper = document.querySelector(`[data-id="${id}"]`);
            if(wrapper) wrapper.remove();

            processedPages = processedPages.filter(p => p.id !== id);
            
            pageCountDisplay.innerText = processedPages.length;
            
            if(processedPages.length === 0) {
                resetUIState();
                selectedFiles = [];
            }
        }
        
        function removeFile(idx) {
            selectedFiles.splice(idx, 1);
            if(selectedFiles.length === 0) resetUIState();
            else generateLivePreview();
        }

        // --- Download Helper ---
        function downloadFile(data, filename, mimeType) {
            try {
                const blob = new Blob([data], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none'; 
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);
            } catch (err) {
                showToast('Download failed.', 'error');
            }
        }

        // --- Core Processing Logic ---
        async function processFiles() {
            if (isProcessing) return;

            if(currentMode === 'protect' || currentMode === 'unlock') {
                const inputVal = toolOptionsArea.querySelector('input').value;
                if(inputVal.trim() === '') {
                    showToast('Please enter the required password.', 'error'); 
                    return;
                }
            }

            isProcessing = true;
            processBtn.disabled = true;
            processBtn.innerText = 'Processing...';
            progressContainer.style.display = 'block';
            statusMessage.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing your file...';

            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                if(progress > 90) clearInterval(interval);
                progressFill.style.width = `${progress}%`;
            }, 50);

            try {
                const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;
                let outputData = null;
                let filename = "brutaltools_output.pdf";
                let mimeType = "application/pdf";

                if (currentMode === 'merge') {
                    const mergedPdf = await PDFDocument.create();
                    for (const p of processedPages) {
                        const arrayBuffer = await p.file.arrayBuffer();
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const [copiedPage] = await mergedPdf.copyPages(pdf, [p.pageIndex - 1]);
                        if(p.rotation !== 0) {
                            const existingRotation = copiedPage.getRotation().angle;
                            copiedPage.setRotation(degrees(existingRotation + p.rotation));
                        }
                        mergedPdf.addPage(copiedPage);
                    }
                    outputData = await mergedPdf.save();
                    filename = "merged_documents.pdf";

                } else if (currentMode === 'rotate') {
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    const pages = pdfDoc.getPages();
                    pages.forEach((page, index) => {
                        const id = `0-${index + 1}`;
                        const p = processedPages.find(x => x.id === id);
                        const rotation = p ? p.rotation : 0;
                        if(rotation !== 0) {
                            const current = page.getRotation().angle;
                            page.setRotation(degrees(current + rotation));
                        }
                    });
                    outputData = await pdfDoc.save();
                    filename = "rotated_document.pdf";

                } else if (currentMode === 'img2pdf') {
                    const pdfDoc = await PDFDocument.create();
                    for (const p of processedPages) {
                        const arrayBuffer = await p.file.arrayBuffer();
                        let img;
                        if (p.file.type === 'image/jpeg') img = await pdfDoc.drawJpg(arrayBuffer);
                        else if (p.file.type === 'image/png') img = await pdfDoc.drawPng(arrayBuffer);
                        else continue;
                        const page = pdfDoc.addPage();
                        const { width, height } = img.scale(1);
                        const pageWidth = page.getWidth();
                        const pageHeight = page.getHeight();
                        let dims = img.scale(1);
                        if(p.rotation !== 0) page.setRotation(degrees(p.rotation));
                        if (dims.width > pageWidth || dims.height > pageHeight) {
                            const ratio = Math.min(pageWidth / dims.width, pageHeight / dims.height);
                            dims = img.scale(ratio);
                        }
                        page.drawImage(img, {
                            x: pageWidth / 2 - dims.width / 2,
                            y: pageHeight / 2 - dims.height / 2,
                            width: dims.width,
                            height: dims.height,
                        });
                    }
                    outputData = await pdfDoc.save();
                    filename = "images_to_pdf.pdf";

                } else if (currentMode === 'pagenumbers') {
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    const pages = pdfDoc.getPages();
                    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    const fontSize = 12;
                    pages.forEach((page, index) => {
                        const { width } = page.getSize();
                        page.drawText(`${index + 1}`, {
                            x: width - 30,
                            y: 30,
                            size: fontSize,
                            font: font,
                            color: rgb(0, 0, 0),
                        });
                    });
                    outputData = await pdfDoc.save();
                    filename = "numbered_document.pdf";

                } else if (currentMode === 'watermark') {
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    const pages = pdfDoc.getPages();
                    const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                    pages.forEach(page => {
                        const { width, height } = page.getSize();
                        page.drawText(watermarkText, {
                            x: width / 2 - (font.widthOfTextAtSize(watermarkText, 50) / 2),
                            y: height / 2 - 10,
                            size: 50,
                            font: font,
                            color: rgb(0.95, 0.95, 0.95),
                            opacity: 0.5,
                            rotate: degrees(45),
                        });
                    });
                    outputData = await pdfDoc.save();
                    filename = "watermarked_document.pdf";

                } else if (currentMode === 'protect') {
                    const userPassword = toolOptionsArea.querySelector('input').value;
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    outputData = await pdfDoc.save({ userPassword: userPassword });
                    filename = "protected_document.pdf";

                } else if (currentMode === 'unlock') {
                    const userPassword = toolOptionsArea.querySelector('input').value;
                    try {
                        const arrayBuffer = await selectedFiles[0].arrayBuffer();
                        const pdfDoc = await PDFDocument.load(arrayBuffer, { password: userPassword });
                        outputData = await pdfDoc.save();
                        filename = "unlocked_document.pdf";
                    } catch (err) { throw new Error('Incorrect password or encryption not supported.'); }

                } else if (currentMode === 'compress') {
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    outputData = await pdfDoc.save({ useObjectStreams: true }); 
                    filename = "compressed_document.pdf";

                } else if (currentMode === 'split') {
                    const zip = new JSZip();
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    for (let i = 0; i < pdfDoc.getPageCount(); i++) {
                        const newPdf = await PDFDocument.create();
                        const [page] = await newPdf.copyPages(pdfDoc, [i]);
                        newPdf.addPage(page);
                        const bytes = await newPdf.save();
                        zip.file(`page_${i + 1}.pdf`, bytes);
                    }
                    outputData = await zip.generateAsync({type:"blob"});
                    filename = "split_pages.zip";
                    mimeType = "application/zip";

                } else if (currentMode === 'pdf2img') {
                    const zip = new JSZip();
                    const arrayBuffer = await selectedFiles[0].arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const pageCount = pdf.numPages;
                    for(let i = 1; i <= pageCount; i++){
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 }); 
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
                        zip.file(`page_${i}.jpg`, blob);
                    }
                    outputData = await zip.generateAsync({type:"blob"});
                    filename = "images.zip";
                    mimeType = "application/zip";

                } else if (currentMode === 'office2pdf') {
                    const file = selectedFiles[0];
                    const fileURL = URL.createObjectURL(file);
                    const win = window.open(fileURL, '_blank');
                    statusMessage.innerHTML = '<span class="status-text-success">Document opened. Please select "Save as PDF" in print dialog.</span>';
                    setTimeout(() => {
                        window.URL.revokeObjectURL(fileURL);
                        win.close();
                        resetUIState(); 
                        showToast('Conversion requires manual save action.', 'success');
                    }, 3000);
                    outputData = await file.arrayBuffer();
                    filename = file.name + ".pdf";
                    throw new Error('Manual Save Triggered');
                }

                clearInterval(interval);
                progressFill.style.width = '100%';
                globalResultBlob = outputData;
                isProcessing = false;
                statusMessage.innerHTML = '<span class="status-text-success"><i class="fa-solid fa-check-circle"></i> Success! Click Download.</span>';
                processBtn.className = "process-btn success-mode";
                processBtn.disabled = false;
                processBtn.innerHTML = `<span>Download Result</span> <i class="fa-solid fa-download"></i>`;
                processBtn.onclick = function() { downloadFile(globalResultBlob, filename, mimeType); };
                showToast('Processing Complete!', 'success');

            } catch (err) {
                console.error(err);
                if(err.message !== 'Manual Save Triggered') {
                    showToast(err.message || 'An error occurred.', 'error');
                    resetUIState();
                }
            }
        }
        
        // --- Toast & Filters ---
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast');
            const msgEl = document.getElementById('toastMessage');
            toastEl.className = `toast ${type}`;
            msgEl.innerText = message;
            toastEl.classList.add('show');
            setTimeout(() => { toastEl.classList.remove('show'); }, 3500);
        }

        function filterTools() {
            const query = document.getElementById('toolSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.tool-card');
            cards.forEach(card => {
                const title = card.querySelector('.tool-title').innerText.toLowerCase();
                const desc = card.querySelector('.tool-desc').innerText.toLowerCase();
                const category = card.getAttribute('data-category');
                const activeCatBtn = document.querySelector('.category-btn.active');
                const activeCat = activeCatBtn ? activeCatBtn.innerText.toLowerCase() : 'all';
                
                const categoryMatch = (activeCat === 'all') || (activeCat === 'organize' && category === 'organize') || (activeCat === 'convert to pdf' && category === 'convert') || (activeCat === 'convert from pdf' && category === 'convert-from') || (activeCat === 'optimize' && category === 'optimize') || (activeCat === 'security' && category === 'security');
                const textMatch = title.includes(query) || desc.includes(query);
                card.style.display = textMatch && categoryMatch ? 'flex' : 'none';
            });
        }

        function filterCategory(cat, btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterTools();
        }
    </script>
</body>
</html>
